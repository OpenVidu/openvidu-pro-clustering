# ------------------------------------------------------------------------------
#
#    DO NOT MODIFY THIS FILE !!!
#
#    Configuration properties should be specified in .env file
#
#    This docker-compose file coordinates all services of OpenVidu CE Platform.
#
# ------------------------------------------------------------------------------

version: '3.1'

services:
    kms:
        image: ${KMS_IMAGE:-kurento/kurento-media-server:6.13.1}
        restart: always
        network_mode: host
        ulimits:
            core: -1
        volumes:
            - /opt/openvidu/recordings:/opt/openvidu/recordings
            - /opt/openvidu/kms-crashes:/opt/openvidu/kms-crashes
        environment:
            - KMS_MIN_PORT=40000
            - KMS_MAX_PORT=57000
            - GST_DEBUG=${KMS_DEBUG_LEVEL:-}

    filebeat:
        image: "docker.elastic.co/beats/filebeat:7.6.2"
        network_mode: host
        restart: always
        user: root
        volumes:
            - ./filebeat_conf/filebeat.yml:/usr/share/filebeat/filebeat.yml:ro
            - /var/lib/docker:/var/lib/docker:ro
            - /var/run/docker.sock:/var/run/docker.sock
        command: filebeat -e -strict.perms=false -E "output.elasticsearch.hosts=['${ELASTICSEARCH_URL}']"

    nginx:
        image: openvidu/openvidu-proxy:2.0.0-beta1
        entrypoint: ['/bin/sh', '-c', 'nginx -g "daemon on;" && tail -f /var/log/nginx/*.log']
        restart: on-failure
        network_mode: host
        volumes:
            - ./nginx_conf/nginx.conf:/etc/nginx/nginx.conf
            - ./nginx_conf/kms-recorder.conf:/etc/nginx/conf.d/default.conf
            - /opt/openvidu/recordings:/opt/openvidu/recordings
