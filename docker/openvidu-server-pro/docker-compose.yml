# ------------------------------------------------------------------------------
#
#    DO NOT MODIFY THIS FILE !!!
#
#    Configuration properties should be specified in .env file
#
#    Application based on OpenVidu should be specified in
#    docker-compose.override.yml file
#
#    This docker-compose file coordinates all services of OpenVidu CE Platform.
#
#    This file will be overridden when update OpenVidu Platform
#
# ------------------------------------------------------------------------------

version: '3.1'

services:

    openvidu-server:
        image: openvidu/openvidu-server-pro:2.13.0-beta3
        restart: on-failure
        network_mode: host
        volumes:
            - /var/run/docker.sock:/var/run/docker.sock
            - ${OPENVIDU_RECORDING_PATH}:${OPENVIDU_RECORDING_PATH}
            - ${OPENVIDU_RECORDING_CUSTOM_LAYOUT}:${OPENVIDU_RECORDING_CUSTOM_LAYOUT}
            - ${OPENVIDU_CDR_PATH}:${OPENVIDU_CDR_PATH}
            - ./aws:/opt/openvidu/cluster/aws
            - .env:${PWD}/.env
        env_file:
            - .env
        environment:
            - SERVER_SSL_ENABLED=false
            - SERVER_PORT=5443
            - OPENVIDU_RECORDING=true
            - OPENVIDU_RECORDING_COMPOSED_URL=https://${OPENVIDU_DOMAIN_OR_PUBLIC_IP}/inspector
            - KMS_URIS=[]
            - COTURN_IP=${OPENVIDU_DOMAIN_OR_PUBLIC_IP}
            - COTURN_REDIS_IP=127.0.0.1
            - OPENVIDU_PRO_CLUSTER=true
            - OPENVIDU_PRO_KIBANA_HOST=http://127.0.0.1/kibana
            - OPENVIDU_PRO_ELASTICSEARCH_HOST=http://127.0.0.1:9200
            - WAIT_KIBANA_URL=http://127.0.0.1:5601/app/kibana
            - DOTENV_PATH=${PWD}

    redis:
        image: redis:5.0.7
        restart: always
        network_mode: host

    coturn:
        image: openvidu/openvidu-coturn:1.0.0-beta1
        restart: on-failure
        network_mode: host
        environment:
            - REDIS_IP=127.0.0.1
            - TURN_LISTEN_PORT=3478
            - DB_NAME=0
            - DB_PASSWORD=turn
            - MIN_PORT=57001
            - MAX_PORT=65535

    nginx:
        image: openvidu/openvidu-proxy:1.0.0-beta3
        restart: on-failure
        network_mode: host
        entrypoint: ["/bin/bash", "-c", "htpasswd -bc /etc/nginx/kibana.htpasswd ${KIBANA_USER} ${KIBANA_PASSWORD} && /usr/local/bin/entrypoint.sh"]
        volumes:
            - ./certificates:/etc/letsencrypt
            - ./owncert:/owncert
            - /opt/openvidu/custom-layout:/opt/openvidu/custom-layout
        environment:
            - DOMAIN_OR_PUBLIC_IP=${OPENVIDU_DOMAIN_OR_PUBLIC_IP}
            - CERTIFICATE_TYPE=${CERTIFICATE_TYPE}
            - LETSENCRYPT_EMAIL=${LETSENCRYPT_EMAIL}
            - PROXY_MODE=PRO
            - WITH_DEMOS=true

    elasticsearch:
        image: docker.elastic.co/elasticsearch/elasticsearch:7.6.2
        restart: always
        environment:
            - discovery.type=single-node
        ports:
            - 9200:9200

    kibana:
        image: docker.elastic.co/kibana/kibana:7.6.2
        restart: always
        environment:
            - SERVER_BASEPATH="/kibana"
        ports:
            - 5601:5601
